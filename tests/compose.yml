services:
  e2e-jest:
    profiles: ["test", "browser-test"]
    image: node:22-alpine
    working_dir: /app
    environment:
      - DOMAIN=${DOMAIN}
      - PARTITION=${PARTITION}
    volumes:
      - ./:/app/tests/
      - ../jest.config.js:/app/jest.config.js
      - ../package-lock.json:/app/package-lock.json
      - ../package.json:/app/package.json
      - ../tsconfig.json:/app/tsconfig.json
    depends_on:
      ozone-https-check:
        condition: service_healthy
      maildev:
        condition: service_healthy
      pds-https-check:
        condition: service_healthy
      hepa:
        condition: service_healthy
    command: >
      sh -c "npm install && npm test"

  e2e-playwright:
    profiles: ["test", "browser-test"]
    image: mcr.microsoft.com/playwright:v1.56.1-noble
    working_dir: /app
    environment:
      - DOMAIN=${DOMAIN}
      - PARTITION=${PARTITION}
      - CI=true
      - OZONE_ADMIN_PASSWORD=${OZONE_ADMIN_PASSWORD:-admin-password}
    volumes:
      - ./browser:/app/tests/browser
      - ../playwright.config.ts:/app/playwright.config.ts
      - ../package-lock.json:/app/package-lock.json
      - ../package.json:/app/package.json
      - ../tsconfig.json:/app/tsconfig.json
      - ../playwright-report:/app/playwright-report
      - ../test-results:/app/test-results
    depends_on:
      e2e-jest:
        condition: service_completed_successfully
      ozone-https-check:
        condition: service_healthy
      pds-https-check:
        condition: service_healthy
    command: >
      sh -c "npm install && npm run test:browser"

