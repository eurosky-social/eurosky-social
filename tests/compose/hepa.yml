services:
  hepa:
    image: ghcr.io/eurosky-social/indigo:hepa-eurosky-latest
    entrypoint: ["/hepa-entrypoint.sh"]
    environment:
      - ATP_RELAY_HOST=ws://relay:3000
      - ATP_PLC_HOST=https://plc.${PARTITION}.${DOMAIN}
      - ATP_OZONE_HOST=https://ozone.${PARTITION}.${DOMAIN}
      - HEPA_OZONE_AUTH_ADMIN_TOKEN=admin123
      - ATP_PDS_HOST=https://pds.${PARTITION}.${DOMAIN}
      - HEPA_PDS_AUTH_ADMIN_TOKEN=${PDS_ADMIN_PASSWORD:-admin}
      - HEPA_COLLECTION_FILTER=app.flashes.feed.post
      - HEPA_CSAM_HOST=http://mock-csam:8080
      - HEPA_CSAM_API_TOKEN=test-csam-token
      - GODEBUG=netdns=go
      - TZ=Etc/UTC
    volumes:
      - ozone_data:/data
      - ./hepa-entrypoint.sh:/hepa-entrypoint.sh:ro
    depends_on:
      relay-https-check:
        condition: service_healthy
      ozone-https-check:
        condition: service_healthy
      pds-https-check:
        condition: service_healthy
      mock-csam:
        condition: service_started
      setup-ozone:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "pidof hepa || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  mock-csam:
    image: ghcr.io/eurosky-social/indigo:mock-csam-eurosky-latest
    environment:
      - MOCK_CSAM_PORT=8080
      - CSAM_HASHES=0644efbdf54d091448d05cfc745e2e0b41d9ae540d399fe65e0e60272e0431e5
